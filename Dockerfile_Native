#LINUX AMD64 && ARM64
FROM debian:bookworm-slim AS graalvm_setup

ENV GRAALVM_HOME="/usr/local/graalvm"
ENV JAVA_VERSION="21"

ENV AMD64="https://github.com/graalvm/graalvm-ce-builds/releases/download/jdk-21.0.2/graalvm-community-jdk-21.0.2_linux-x64_bin.tar.gz"
ENV ARM64="https://github.com/graalvm/graalvm-ce-builds/releases/download/jdk-21.0.2/graalvm-community-jdk-21.0.2_linux-aarch64_bin.tar.gz"

# install GraalVM + prerequisites (native-image reqs from official docs)
RUN set -eux; \
    GRAALVM_DOWNLOAD_URL=$(if [ "$(uname -m)" = "aarch64" ]; then echo "${ARM64}"; else echo "${AMD64}"; fi); \
    apt-get update; \
    apt-get install -y --no-install-recommends curl ca-certificates locales locales-all build-essential zlib1g-dev libz-dev maven; \
    mkdir -p "${GRAALVM_HOME}"; \
    curl -sSL -o graalvm.tar.gz "${GRAALVM_DOWNLOAD_URL}"; \
    tar -zxf graalvm.tar.gz -C "${GRAALVM_HOME}" --strip-components 1; \
    rm -f graalvm.tar.gz; \
    apt-get clean; \
    rm -rf /var/lib/apt/lists/*

ENV PATH="${GRAALVM_HOME}/bin:${PATH}"
ENV JAVA_HOME="${GRAALVM_HOME}"

FROM graalvm_setup AS copy_sources
WORKDIR /build
COPY pom.xml .
COPY src ./src
COPY AGENTS.md README.md ./

FROM copy_sources AS native_build
ENV LC_ALL=en_US.UTF-8
ENV LANG=en_US.UTF-8
ENV LANGUAGE=en_US.UTF-8

# build + smoke-test the native executable
RUN mvn -B -q -DskipTests -Pnative clean package \
    && printf '<html><body><p>native-ok</p></body></html>' > /tmp/sample.html \
    && ./target/email-html-validator.native /tmp/sample.html --output-dir /tmp/native-report \
    && test -f /tmp/native-report/report.json

FROM scratch AS export
COPY --from=native_build /build/target/*.native /email-html-validator.native

FROM debian:bookworm-slim AS native_image
WORKDIR /app
COPY --from=native_build /build/target/*.native /email-html-validator.native
ENV LC_ALL=en_US.UTF-8
ENV LANG=en_US.UTF-8
ENV LANGUAGE=en_US.UTF-8
ENTRYPOINT ["/email-html-validator.native"]
